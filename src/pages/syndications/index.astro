---
import "~/styles/syndications.css";
import Layout from "~/layouts/Layout.astro";
import Wrapper from "~/components/wrapper.astro";
import { getCollection, type CollectionEntry } from "astro:content";

const syndications: CollectionEntry<"syndications">[] =
  await getCollection("syndications");

syndications.sort(
  (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime(),
);

// Group by year
const grouped: Record<number, CollectionEntry<"syndications">[]> = {};
for (const s of syndications) {
  const year = s.data.pubDate.getFullYear();
  if (!grouped[year]) grouped[year] = [];
  grouped[year].push(s);
}
const years = Object.keys(grouped)
  .map(Number)
  .sort((a, b) => b - a);

// Collect unique tags for filter chips
const allTags = [...new Set(syndications.flatMap((s) => s.data.tags || []))].sort();

// Generate short git-like hash from slug
function generateHash(slug: string): string {
  let hash = 0;
  for (let i = 0; i < slug.length; i++) {
    const char = slug.charCodeAt(i);
    hash = (hash << 5) - hash + char;
    hash = hash & hash;
  }
  return Math.abs(hash).toString(16).padStart(7, "0").slice(0, 7);
}

function formatDate(date: Date): string {
  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "short",
    day: "numeric",
  });
}
---

<Layout title="Syndications" description="Personal updates and reflections.">
  <Wrapper>
    <div class="syn">
      <div class="syn-header">
        <h1 class="syn-title">syndications</h1>
        <span class="syn-ref">(HEAD &rarr; main, origin/main)</span>
      </div>

      <div class="syn-filters" role="tablist">
        <button class="syn-chip syn-chip--active" data-filter="all">all</button>
        {allTags.map((tag) => (
          <button class="syn-chip" data-filter={tag}>{tag}</button>
        ))}
      </div>

      <div class="syn-log">
        <div class="syn-line" aria-hidden="true"></div>

        {years.map((year) => (
          <div class="syn-year" data-year={year}>
            <div class="syn-year-label">{year}</div>

            {grouped[year].map((entry) => {
              const tags = entry.data.tags || [];
              const hash = generateHash(entry.slug);
              return (
                <div class="syn-entry" data-tags={tags.join(",")}>
                  <div class="syn-dot" aria-hidden="true" />
                  <div class="syn-body">
                    <a href={`/syndications/${entry.slug}`} class="syn-link">
                      <code class="syn-hash">{hash}</code>
                      <span class="syn-msg">{entry.data.title}</span>
                    </a>
                    <div class="syn-meta">
                      {tags.map((t) => (
                        <span class="syn-tag">#{t}</span>
                      ))}
                      <span class="syn-date">&middot; {formatDate(entry.data.pubDate)}</span>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        ))}
      </div>
    </div>
  </Wrapper>
</Layout>

<script>
  const chips = document.querySelectorAll<HTMLButtonElement>(".syn-chip");
  const entries = document.querySelectorAll<HTMLElement>(".syn-entry");
  const yearGroups = document.querySelectorAll<HTMLElement>(".syn-year");

  chips.forEach((chip) => {
    chip.addEventListener("click", () => {
      chips.forEach((c) => c.classList.remove("syn-chip--active"));
      chip.classList.add("syn-chip--active");

      const filter = chip.dataset.filter ?? "all";

      entries.forEach((entry) => {
        const tags = entry.dataset.tags?.split(",") ?? [];
        if (filter === "all" || tags.includes(filter)) {
          entry.removeAttribute("data-hidden");
        } else {
          entry.setAttribute("data-hidden", "");
        }
      });

      yearGroups.forEach((group) => {
        const hasVisible = group.querySelector(".syn-entry:not([data-hidden])");
        group.toggleAttribute("data-hidden", !hasVisible);
      });
    });
  });
</script>
